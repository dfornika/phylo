# Phylo

[![Tests](https://github.com/dfornika/phylo/actions/workflows/test.yml/badge.svg)](https://github.com/dfornika/phylo/actions/workflows/test.yml)

A phylogenetic tree viewer built with ClojureScript and [UIx](https://github.com/pitch-io/uix) (React 19).

Phylo renders Newick-format trees as interactive SVGs with support for metadata overlays from CSV/TSV files. Tree width and vertical spacing are adjustable via slider controls.

![Screenshot](doc/images/screenshot-01.png)

## Prerequisites

- [Clojure CLI](https://clojure.org/guides/install_clojure) (1.11+)
- [Node.js](https://nodejs.org/) (18+)

## Getting Started

```bash
# Install npm dependencies
npm install

# Start the development server (shadow-cljs watch + hot reload)
npm run dev
```

Open [http://localhost:8080](http://localhost:8080) in your browser.

## Project Structure

```
src/
  main/
    app/
      core.cljs               # Thin app shell — mount, init, re-render
      state.cljs              # Shared state atoms, React context, use-app-state hook
      layout.cljs             # LAYOUT constant — spacing, padding, marker sizes
      tree.cljs               # Pure tree layout functions (assign coords, prepare-tree, etc.)
      newick.cljs             # Newick tree format parser
      csv.cljs                # CSV/TSV parser with metadata column support
      specs.cljs              # clojure.spec definitions for data structures & props
      components/
        tree.cljs             # Branch, TreeNode, PhylogeneticTree — SVG tree rendering
        metadata.cljs         # StickyHeader, MetadataColumn, MetadataTable
        toolbar.cljs          # Toolbar, DateRangeFilter — user controls
        viewer.cljs           # TreeContainer, TreeViewer, ScaleGridlines, PixelGrid
  test/
    app/
      tree_test.cljs          # Tests for tree layout functions
      newick_test.cljs        # Tests for Newick parser
      csv_test.cljs           # Tests for CSV/TSV parser
  dev/
    user.clj                  # REPL helper for shadow-cljs
```

### Data Flow

```
Newick string
  → newick/newick->map     (parse to tree map)
  → tree/assign-y-coords   (vertical layout)
  → tree/assign-x-coords   (horizontal layout)
  → tree/prepare-tree      (enrich leaves with metadata)
  → PhylogeneticTree       (SVG rendering + metadata overlay)
```

## Running Tests

Tests run on Node.js via shadow-cljs `:node-test` target:

```bash
# Single run
npm test

# Watch mode (auto-rerun on changes)
npm run test:watch
```

## Generating API Docs

API documentation is generated by [Codox](https://github.com/weavejester/codox) from function docstrings:

```bash
npm run docs
# or directly:
clojure -X:codox
```

Output is written to `target/doc/`. Open `target/doc/index.html` to browse.

## Available npm Scripts

| Script | Description |
|--------|-------------|
| `npm run dev` | Start shadow-cljs dev server with hot reload |
| `npm run build` | Production release build |
| `npm test` | Compile and run tests (single run) |
| `npm run test:watch` | Run tests in watch mode |
| `npm run docs` | Generate API docs with Codox |

## Architecture

See [doc/01-architecture.md](doc/01-architecture.md) for details on the component hierarchy, data flow, and layout system.

## License

MIT
